<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√¥ ph·ªèng D√≤ng ch·∫£y Th√¥ng minh</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ M√î PH·ªéNG D√íNG CH·∫¢Y TH√îNG MINH</h1>
            <p>Upload b·∫£n v·∫Ω ‚Üí V·∫Ω ƒë∆∞·ªùng d·∫´n ‚Üí Ch·ªçn nguy√™n li·ªáu ‚Üí Ch·∫°y m√¥ ph·ªèng</p>
        </div>

        <div class="main-content">
            <!-- Left Sidebar - Main Tools -->
            <div class="sidebar">
                <!-- Upload Section -->
                <div class="tool-section">
                    <div class="section-title">üìÅ UPLOAD B·∫¢N V·∫º</div>
                    <div class="upload-options">
                        <div class="upload-option">
                            <input type="file" id="backgroundUpload" class="file-upload" accept="image/*">
                            <label for="backgroundUpload" class="upload-btn">
                                <span>üñºÔ∏è</span>
                                <div>·∫¢nh N·ªÅn</div>
                                <small>PNG, JPG, GIF</small>
                            </label>
                        </div>
                        
                        <div class="upload-option">
                            <input type="file" id="gifUpload" class="file-upload" accept=".gif">
                            <label for="gifUpload" class="upload-btn">
                                <span>üéûÔ∏è</span>
                                <div>GIF Animation</div>
                                <small>File GIF</small>
                            </label>
                        </div>
                    </div>
                    
                    <div class="upload-preview" id="uploadPreview">
                        <div class="preview-placeholder">
                            <span>üìÅ</span>
                            <div>Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c t·∫£i</div>
                        </div>
                    </div>
                </div>

                <!-- Drawing Tools -->
                <div class="tool-section">
                    <div class="section-title">üé® C√îNG C·ª§ V·∫º</div>
                    <div class="tool-buttons">
                        <button class="btn btn-primary" id="brushTool">
                            <span>üñåÔ∏è</span> BRUSH
                        </button>
                        <button class="btn btn-primary" id="penTool">
                            <span>‚úèÔ∏è</span> PEN
                        </button>
                        <button class="btn btn-warning" id="eraserTool">
                            <span>üßπ</span> X√ìA
                        </button>
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">K√≠ch th∆∞·ªõc c√¥ng c·ª•</span>
                            <span class="slider-value" id="toolSizeValue">15px</span>
                        </div>
                        <input type="range" id="toolSize" min="1" max="100" value="15">
                    </div>
                </div>

                <!-- Materials -->
                <div class="tool-section">
                    <div class="section-title">üåæ NGUY√äN LI·ªÜU</div>
                    <div class="material-grid">
                        <div class="material-card active" data-material="water">
                            <div class="material-icon">üíß</div>
                            <div class="material-name">N∆Ø·ªöC</div>
                            <div class="material-desc">Ch·∫£y m∆∞·ª£t, trong su·ªët</div>
                        </div>
                        <div class="material-card" data-material="wheat">
                            <div class="material-icon">üåæ</div>
                            <div class="material-name">L√öA M√å</div>
                            <div class="material-desc">H·∫°t nh·ªè, m√†u v√†ng</div>
                        </div>
                        <div class="material-card" data-material="sand">
                            <div class="material-icon">üü´</div>
                            <div class="material-name">C√ÅT</div>
                            <div class="material-desc">H·∫°t m·ªãn, r∆°i nhanh</div>
                        </div>
                        <div class="material-card" data-material="grains">
                            <div class="material-icon">üü®</div>
                            <div class="material-name">H·∫†T</div>
                            <div class="material-desc">K√≠ch th∆∞·ªõc l·ªõn</div>
                        </div>
                    </div>
                </div>

                <!-- Simulation Control -->
                <div class="tool-section">
                    <div class="section-title">üöÄ ƒêI·ªÄU KHI·ªÇN</div>
                    <div class="tool-buttons">
                        <button class="btn btn-success" id="startBtn">
                            <span>‚ñ∂Ô∏è</span> CH·∫†Y
                        </button>
                        <button class="btn btn-danger" id="stopBtn">
                            <span>‚èπÔ∏è</span> D·ª™NG
                        </button>
                        <button class="btn btn-warning" id="clearBtn">
                            <span>üóëÔ∏è</span> X√ìA
                        </button>
                    </div>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-area">
                <canvas id="simulationCanvas"></canvas>
                <div class="canvas-overlay">
                    <div class="status-info">
                        <div class="status-dot" id="statusDot"></div>
                        <div>
                            <div id="statusText">S·∫¥N S√ÄNG - UPLOAD B·∫¢N V·∫º ƒê·ªÇ B·∫ÆT ƒê·∫¶U</div>
                            <div style="font-size: 12px; color: #7f8c8d;" id="materialText">Nguy√™n li·ªáu: N∆Ø·ªöC</div>
                        </div>
                    </div>
                    <div class="stats">
                        <div class="stat-item">
                            <span>üî¥</span>
                            <span id="particleCount">0</span> h·∫°t
                        </div>
                        <div class="stat-item">
                            <span>üìê</span>
                            <span id="pathLength">0</span> px
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Advanced Controls -->
            <div class="right-panel">
                <div class="tool-section">
                    <div class="section-title">üéõÔ∏è CHUY·ªÇN ƒê·ªòNG</div>
                    
                    <div class="control-group">
                        <div class="control-title">üîÑ Ki·ªÉu chuy·ªÉn ƒë·ªông</div>
                        <div class="motion-controls" style="justify-content: center; margin-bottom: 20px;">
                            <button class="motion-btn active" data-motion="linear">‚Üí</button>
                            <button class="motion-btn" data-motion="spiral">üåÄ</button>
                            <button class="motion-btn" data-motion="wave">üåä</button>
                            <button class="motion-btn" data-motion="pulse">üíì</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-title">‚öôÔ∏è V·∫¨T L√ù</div>
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label">T·ªëc ƒë·ªô</span>
                                <span class="slider-value" id="speedValue">5</span>
                            </div>
                            <input type="range" id="speed" min="1" max="10" value="5">
                        </div>
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label">Tr·ªçng l·ª±c</span>
                                <span class="slider-value" id="gravityValue">0.5</span>
                            </div>
                            <input type="range" id="gravity" min="0" max="2" step="0.1" value="0.5">
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-title">üéØ H∆Ø·ªöNG</div>
                        <div class="direction-controls">
                            <button class="direction-btn active" data-direction="forward">‚Üë TI·∫æN</button>
                            <button class="direction-btn" data-direction="backward">‚Üì L√ôI</button>
                            <button class="direction-btn" data-direction="vortex_cw">‚Üª XO√ÅY</button>
                            <button class="direction-btn" data-direction="random">üé≤ NG·∫™U NHI√äN</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    // ====== SMART ANIMATION SYSTEM ======
    createSmartParticles() {
        this.particles = [];
        
        this.paths.forEach((path, pathIndex) => {
            if (path.tool === 'eraser') return;
            
            const material = path.material || this.currentMaterial;
            const props = this.getParticleProperties(material);
            
            this.createParticlesForPath(path, props, pathIndex);
        });
        
        this.updateStats();
        console.log(`üéØ ƒê√£ t·∫°o ${this.particles.length} h·∫°t th√¥ng minh`);
    }

    createParticlesForPath(path, props, pathId) {
        const points = path.points;
        if (points.length < 2) return;
        
        // T√≠nh t·ªïng chi·ªÅu d√†i ƒë∆∞·ªùng
        let totalLength = 0;
        const segmentLengths = [];
        
        for (let i = 0; i < points.length - 1; i++) {
            const length = this.calculateDistance(points[i], points[i + 1]);
            segmentLengths.push(length);
            totalLength += length;
        }
        
        // S·ªë h·∫°t t·ª∑ l·ªá v·ªõi chi·ªÅu d√†i ƒë∆∞·ªùng
        const particleCount = Math.max(5, Math.floor(totalLength / 10));
        
        for (let i = 0; i < particleCount; i++) {
            const progress = i / particleCount;
            const position = this.getPointAtProgress(points, progress, segmentLengths, totalLength);
            
            if (position) {
                this.particles.push({
                    x: position.x,
                    y: position.y,
                    vx: 0,
                    vy: 0,
                    size: Math.random() * (props.size[1] - props.size[0]) + props.size[0],
                    color: props.color,
                    pathId: pathId,
                    progress: progress,
                    speed: 0.01 + Math.random() * 0.02,
                    life: 0.5 + Math.random() * 0.5,
                    material: path.material || this.currentMaterial,
                    originalSize: 0 // S·∫Ω set sau
                });
                
                // L∆∞u k√≠ch th∆∞·ªõc g·ªëc
                this.particles[this.particles.length - 1].originalSize = 
                    this.particles[this.particles.length - 1].size;
            }
        }
    }

    calculateDistance(point1, point2) {
        return Math.sqrt(
            Math.pow(point2.x - point1.x, 2) + 
            Math.pow(point2.y - point1.y, 2)
        );
    }

    getPointAtProgress(points, progress, segmentLengths, totalLength) {
        if (points.length < 2) return null;
        
        const targetDistance = progress * totalLength;
        let accumulated = 0;
        
        for (let i = 0; i < segmentLengths.length; i++) {
            const segmentLength = segmentLengths[i];
            
            if (targetDistance <= accumulated + segmentLength) {
                const segmentProgress = (targetDistance - accumulated) / segmentLength;
                return {
                    x: points[i].x + (points[i + 1].x - points[i].x) * segmentProgress,
                    y: points[i].y + (points[i + 1].y - points[i].y) * segmentProgress
                };
            }
            accumulated += segmentLength;
        }
        
        return points[points.length - 1];
    }

    updateSmartParticles() {
        this.particles.forEach(particle => {
            // C·∫¨P NH·∫¨T TI·∫æN TR√åNH
            particle.progress += particle.speed * (this.physics.speed / 8);
            
            if (particle.progress >= 1.0) {
                particle.progress = 0; // Reset v·ªÅ ƒë·∫ßu
                particle.life = 0.5 + Math.random() * 0.5; // Reset life
            }
            
            // C·∫¨P NH·∫¨T V·ªä TR√ç THEO ƒê∆Ø·ªúNG
            const path = this.paths[particle.pathId];
            if (path && path.points.length >= 2) {
                const segmentLengths = this.calculateSegmentLengths(path.points);
                const totalLength = segmentLengths.reduce((a, b) => a + b, 0);
                const newPos = this.getPointAtProgress(
                    path.points, 
                    particle.progress, 
                    segmentLengths, 
                    totalLength
                );
                
                if (newPos) {
                    particle.x = newPos.x;
                    particle.y = newPos.y;
                }
            }
            
            // √ÅP D·ª§NG CHUY·ªÇN ƒê·ªòNG & V·∫¨T L√ù
            this.applyAdvancedMotion(particle);
            
            // C·∫¨P NH·∫¨T V√íNG ƒê·ªúI
            particle.life -= 0.005;
            if (particle.life <= 0) {
                this.resetParticle(particle);
            }
        });
    }

    calculateSegmentLengths(points) {
        const segmentLengths = [];
        for (let i = 0; i < points.length - 1; i++) {
            segmentLengths.push(this.calculateDistance(points[i], points[i + 1]));
        }
        return segmentLengths;
    }

    applyAdvancedMotion(particle) {
        const time = Date.now() * 0.001;
        
        switch(this.currentMotion) {
            case 'linear':
                // Gi·ªØ nguy√™n - di chuy·ªÉn theo ƒë∆∞·ªùng
                break;
                
            case 'spiral':
                // Xo·∫Øn ·ªëc quanh ƒë∆∞·ªùng
                const radius = 8 * Math.sin(time + particle.progress * Math.PI * 2);
                particle.x += Math.cos(time + particle.progress * Math.PI * 4) * radius * 0.1;
                particle.y += Math.sin(time + particle.progress * Math.PI * 4) * radius * 0.1;
                break;
                
            case 'wave':
                // S√≥ng
                const wave = Math.sin(time * 2 + particle.progress * Math.PI * 6) * 6;
                particle.y += wave * 0.1;
                break;
                
            case 'pulse':
                // Nh·∫•p nh√°y k√≠ch th∆∞·ªõc
                const pulse = Math.sin(time * 3 + particle.progress * Math.PI * 4) * 0.3 + 0.7;
                particle.size = particle.originalSize * pulse;
                break;
        }
        
        this.applySmartDirection(particle);
    }

    applySmartDirection(particle) {
        switch(this.currentDirection) {
            case 'forward':
                // M·∫∑c ƒë·ªãnh
                break;
                
            case 'backward':
                particle.progress -= particle.speed * (this.physics.speed / 8);
                if (particle.progress < 0) particle.progress = 1;
                break;
                
            case 'vortex_cw':
                const vortexTime = Date.now() * 0.003;
                const vortexRadius = 12;
                particle.x += Math.cos(vortexTime + particle.progress * Math.PI * 2) * vortexRadius * 0.1;
                particle.y += Math.sin(vortexTime + particle.progress * Math.PI * 2) * vortexRadius * 0.1;
                break;
                
            case 'random':
                particle.x += (Math.random() - 0.5) * 3;
                particle.y += (Math.random() - 0.5) * 3;
                break;
        }
        
        // √Åp d·ª•ng tr·ªçng l·ª±c
        particle.vy += this.physics.gravity * 0.05;
        particle.y += particle.vy;
    }

    resetParticle(particle) {
        particle.progress = Math.random() * 0.2;
        particle.life = 0.5 + Math.random() * 0.5;
        particle.vy = 0;
        const props = this.getParticleProperties(particle.material);
        particle.size = props.size[0] + Math.random() * (props.size[1] - props.size[0]);
        particle.originalSize = particle.size;
    }
</body>
</html>